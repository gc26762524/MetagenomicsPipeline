library(reshape2)
library(ggplot2)
library(RColorBrewer)


setwd("~/Desktop")

input <-"orthology	sample1	sample2	sample3	sample4	sample5	sample6	sample7	sample8
Aging	117.485183811325	116.126435420246	124.852309897394	158.724343166866	132.442810966574	149.488118059606	126.976819201158	146.457935751096
Amino acid metabolism	1596.8875074215	1220.12670980943	1228.96661844235	1286.42174911073	1365.64737237391	1142.24613719141	1397.84609485134	1266.23013011866
Biosynthesis of other secondary metabolites	959.27074841097	846.000014548738	871.258995519494	820.843735556676	830.112048142681	892.521928388311	872.543221692889	789.806946606843
Cancers: Overview	104.674973201922	107.608512242126	132.064770921387	121.33892820162	123.709055766319	132.038120119756	103.456686986765	126.350105205664
Cancers: Specific types	14.2918994541238	10.2439430059135	7.08632116304581	14.6109107224016	5.78255038727332	8.26559164693953	7.25558903437854	5.08424607054163
Carbohydrate metabolism	1804.01828416153	1830.43152700564	2049.62510851702	1848.3326653022	1826.77837620318	1931.93907923549	1770.70833484917	1814.01419097812
Cardiovascular diseases	28.1708920555196	21.5051356646317	20.7282963720094	23.832445607005	17.0070499629023	25.0807834641305	21.0558359143806	15.9887279369119
Cell growth and death	417.53276759704	444.743124549638	414.448034185078	388.978546586231	471.456218023143	481.054111633195	471.642874367062	477.4660565703
Cell motility	215.138298491652	74.7638750346747	57.3046749112412	126.638430608238	108.894072103253	549.038346944487	252.427930809238	316.443337115598
Cellular community - eukaryotes	0	0.0203505115806623	0.145654326127955	0	0	0.035240784182771	0	0.0546784551756101
Cellular community - prokaryotes	252.416599095556	179.338459428716	186.720086661719	211.320123431751	200.069216894588	207.40382685436	191.317753633623	186.473175536563
Chemical structure transformation maps	16.996399363784	0	0	0	0	0	0	1.74933774446339
Circulatory system	1.63567542980073	0.20404891811515	0.143876409010437	0.835217919045868	0	0.120826856048939	0	0.0125405423192639
Development	0	0.0146429344106934	0	0	0	0	0	0
Digestive system	22.1163619771154	24.8277478784882	15.8160113475533	20.2174809432296	20.4939237130709	16.0577801957919	20.1886024277066	24.0872307424013
Drug resistance: Antimicrobial	321.387254704192	394.013514508109	412.325291521683	324.013614192447	333.941121663082	291.80627227774	312.218584334682	300.914864678012
Drug resistance: Antineoplastic	177.732548327249	190.649609263551	177.735443967756	173.717046748318	157.641416963398	116.945687200807	161.476320179644	133.776226233228
Endocrine and metabolic diseases	115.167862894168	122.938426483863	135.660788510416	118.836934357152	151.607781583441	144.09551603079	137.771170654787	151.721447449351
Endocrine system	202.879600619567	193.223062141613	212.49922340656	196.983650467941	221.412408501337	190.034164830536	192.050090981432	223.653935294635
Energy metabolism	893.157125577457	1057.51833569512	1075.57567176799	952.487634871948	987.046896884049	1011.40846376572	999.107102116743	997.293671833504
Environmental adaptation	27.8773746243552	19.8450910914568	20.1705697856366	19.6247432880099	30.6272953045451	84.4360170950654	45.0756508721657	57.1006802065368
Excretory system	10.4066833241371	4.6446591725069	1.25562843498318	2.36904461509905	0.307378614563512	0.556230626422562	0.789902240901751	0.372406291004833
Folding, sorting and degradation;	502.063357817988	605.112499679287	591.759199087393	599.779575328357	574.04026519752	561.650084337798	577.488708811536	573.231652262681
Global and overview maps	1039.12837234225	903.805541528673	909.798841433752	919.261843776271	954.295073374611	860.064174898454	967.642009183692	924.568289575743
Glycan biosynthesis and metabolism	641.493989153129	629.705905738938	684.611407372103	562.987891396258	481.784571610226	348.199863990236	430.968483287999	391.080134787902
Immune diseases	24.5107920010619	44.9412182463718	43.0116060134355	29.4045536040248	27.5299973946213	31.9439573409172	26.3520749973027	27.2520177603948
Immune system	38.6012907633526	40.018114530641	39.2332002855864	32.4366898770346	26.771130377845	74.3729109558827	41.2765709274452	40.6288607847705
Infectious diseases: Bacterial	126.796113931992	114.002480072502	119.217459301119	126.538160341344	129.418245545184	245.560470565234	162.15568600248	186.557017167187
Infectious diseases: Parasitic	10.5446212120953	4.57086060588739	2.96076786173635	7.60969158418476	18.1439059481828	19.7010342333124	21.2252129478074	20.0687257056755
Infectious diseases: Viral	6.17484857818101	5.41369302048126	6.04692407928546	8.09943277761363	6.64671438514202	5.63280283746139	4.92088116021322	6.06224612873588
Lipid metabolism	711.1431530217	561.476072635852	560.707516812308	694.151868145342	603.441598309173	501.029788464011	591.888246901271	597.804493763706
Membrane transport	265.959537854278	287.541059333087	372.25263395426	319.210377642371	332.186128486322	407.647994098292	306.031596416971	336.510427495426
Metabolism of cofactors and vitamins	1633.48504845569	1534.80497072785	1470.15346042961	1460.75433901244	1189.19997656387	935.315588652356	1225.4437940242	1062.42781901409
Metabolism of other amino acids	1335.815589147	1440.86216690037	1498.88346158183	1532.0117036148	1345.42307766895	1178.02943685751	1265.63106232474	1228.25787563649
Metabolism of terpenoids and polyketides	501.926289055384	445.294809173619	451.808684839536	542.607937181169	371.290751557362	508.813207695387	439.417275678396	441.689096003312
Nervous system	55.4146268147821	39.6133778941036	35.3558143111983	28.7893266418419	65.4843606748246	60.8003219976758	58.1381630530906	72.0754034115543
Neurodegenerative diseases	21.7062485118541	15.440817230934	16.0412072277328	25.296149516244	13.8092508740323	17.1629056321101	12.7883522756469	15.3509162009306
Nucleotide metabolism	368.86504910671	440.443203748772	437.62159964207	400.520925889532	450.918917270876	433.815427108243	438.281914738278	443.213697747652
Replication and repair	1061.01012194706	1299.08570637765	1203.56002217103	1192.09813078413	1103.11404133132	1081.51808898818	1105.03835561743	1037.37346139283
Sensory system	0	0.0299244830112183	0.103378382272531	0	0	0	0	0
Signal transduction	153.736523762824	130.035934210661	137.933307921586	147.033108370942	117.17456091888	145.69529919848	120.347408213069	127.232693151237
Signaling molecules and interaction	0.0737911010093968	0	0	0	0	0	0	0.005643682217754
Substance dependence	4.8317321220642	0.0284801773147647	0.0413293106100201	0	0	0.0746448532708449	0	0.0678728866046088
Transcription	98.794709535172	112.728401008858	126.030794112206	102.392018801061	128.304172355875	133.014152287041	124.211745394523	132.69728961902
Translation	897.497551074688	1141.4042222731	1175.45613280563	1147.15027540811	1234.03762765555	1312.08831493753	1235.86534131049	1273.49944105511
Transport and catabolism	56.5337730622216	42.2382605145334	48.6467888501155	42.7940537023774	37.1038332291933	27.6887090169688	37.2740696959446	36.9386390047478
Xenobiotics biodegradation and metabolism	533.287128493961	422.457907530324	491.314773734175	547.161477963284	445.458473520165	606.112406706886	463.711832222567	560.758421743992
"

data<-read.table(text=input, header=T, row.name = 1, sep="\t")
class(data)
data2<-t(data[,order(colnames(data))])
head(data2)
class(data2)
data3<-prop.table(data2, margin=1)

rowSums(data3)
head(data3)

data4<-data3*100

data5<-melt(data4, id.var="SampleID")
colnames(data5)<-c('SampleID', 'Function', 'Proportion')
pallet<-c(brewer.pal(12,"Paired"),brewer.pal(8,"Set2")[-c(7,8)],brewer.pal(8,"Dark2"),brewer.pal(12,"Set3"),brewer.pal(8,"Accent"),brewer.pal(11,"Spectral"))

p<-ggplot(data5, aes(x = SampleID, y = Proportion, fill = Function)) + 
	geom_bar(stat = "identity",width = 0.7)+
  	guides(fill=guide_legend(title = NULL))+
  	scale_fill_manual(values = pallet)+
 	xlab("")+ylab("Sequence Number Percent(%)")+theme_bw()+
  	theme(text = element_text(size = 10),
        panel.grid.major = element_blank(),panel.grid.minor = element_blank(),
        axis.line = element_line(),panel.border =  element_blank(),
        axis.text.x = element_text(angle = 45,size = 10,hjust = 1))+
  	scale_y_continuous(limits=c(0,101), expand = c(0, 0)
)


ggsave(plot = p,filename = "all.merged.abundance.KeepID.Pathway.Level2.png",width = 20,height = 8,dpi = 300)
ggsave(plot = p,filename = "all.merged.abundance.KeepID.Pathway.Level2.pdf",width = 20,height = 8,dpi = 300)